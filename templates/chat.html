<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with Document</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/marked@4.0.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <style>
        .markdown-content h1 { @apply text-2xl font-bold mb-4 mt-6; }
        .markdown-content h2 { @apply text-xl font-bold mb-3 mt-5; }
        .markdown-content h3 { @apply text-lg font-bold mb-2 mt-4; }
        .markdown-content p { @apply mb-4; }
        .markdown-content ul { @apply list-disc ml-6 mb-4; }
        .markdown-content ol { @apply list-decimal ml-6 mb-4; }
        .markdown-content blockquote { @apply border-l-4 border-gray-300 pl-4 italic my-4; }
        .markdown-content code { @apply bg-gray-100 px-1 rounded; }
        .markdown-content pre { @apply bg-gray-100 p-4 rounded mb-4 overflow-x-auto; }
        .markdown-content a { @apply text-blue-600 hover:underline; }
        .markdown-content table { @apply min-w-full border border-gray-300 mb-4; }
        .markdown-content th { @apply bg-gray-100 border px-4 py-2; }
        .markdown-content td { @apply border px-4 py-2; }
        .markdown-content img { @apply max-w-full h-auto; }
        .markdown-content hr { @apply my-4 border-t border-gray-300; }
        .markdown-content strong { @apply font-bold; }
        .markdown-content em { @apply italic; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg">
            <!-- Header -->
            <div class="border-b p-4 flex justify-between items-center">
                <h1 class="text-xl font-semibold">Document Chat</h1>
                <div class="flex space-x-4 items-center">
                    <select id="api-select" class="border rounded px-3 py-1">
                        {% for api in apis %}
                        <option value="{{ api }}">{{ api|title }}</option>
                        {% endfor %}
                    </select>
                    <label class="flex items-center">
                        <input type="checkbox" id="stream-toggle" class="mr-2" checked>
                        Stream
                    </label>
                    <button onclick="usePreviousContext()"
                            class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 transition-colors">
                        Use Chat History
                    </button>
                    <label class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition-colors cursor-pointer">
                        Add File
                        <input type="file" id="chat-file-input" class="hidden" multiple>
                    </label>
                    <button onclick="clearChat()" class="text-red-600 hover:text-red-800">
                        Clear Chat
                    </button>
                </div>
            </div>

            <!-- File Upload Preview -->
            <div id="file-preview" class="hidden border-b p-2 bg-gray-50">
                <div id="file-list" class="flex flex-wrap gap-2"></div>
            </div>

            <!-- Chat Messages -->
            <div id="chat-messages" class="h-[500px] overflow-y-auto p-4 space-y-4">
                <!-- Messages will be inserted here -->
            </div>

            <!-- Input Area -->
            <div class="border-t p-4">
                <div class="flex space-x-4">
                    <input type="text" id="message-input"
                           class="flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Type your message...">
                    <button onclick="sendMessage()"
                            class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configure marked for syntax highlighting
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(code, { language: lang }).value;
                    } catch (e) {}
                }
                try {
                    return hljs.highlightAuto(code).value;
                } catch (e) {}
                return code;
            }
        });

        const messageInput = document.getElementById('message-input');
        const chatMessages = document.getElementById('chat-messages');
        const apiSelect = document.getElementById('api-select');

        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        function formatMarkdown(content, isUser) {
            if (isUser) return content;
            try {
                return marked.parse(content);
            } catch (e) {
                console.error('Markdown parsing error:', e);
                return content;
            }
        }

        function appendMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;

            const messageBubble = document.createElement('div');
            messageBubble.className = `max-w-[80%] rounded-lg p-3 ${
                isUser ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-800 markdown-content'
            }`;

            if (isUser) {
                messageBubble.textContent = content;
            } else {
                messageBubble.innerHTML = formatMarkdown(content);
                // Initialize syntax highlighting for code blocks
                messageBubble.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightBlock(block);
                });
            }

            messageDiv.appendChild(messageBubble);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageBubble;
        }

        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            const streamMode = document.getElementById('stream-toggle').checked;
            appendMessage(message, true);
            messageInput.value = '';
            messageInput.disabled = true;

            if (streamMode) {
                // Streaming mode
                const responseBubble = appendMessage('', false);
                let fullResponse = '';

                fetch('/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        api: apiSelect.value
                    })
                }).then(response => {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    function processText(text) {
                        const lines = text.split('\n');
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                if (data !== '[DONE]') {
                                    try {
                                        const parsed = JSON.parse(data);
                                        if (parsed.content) {
                                            fullResponse += parsed.content;
                                            responseBubble.innerHTML = formatMarkdown(fullResponse);
                                            // Highlight any code blocks
                                            responseBubble.querySelectorAll('pre code').forEach((block) => {
                                                hljs.highlightBlock(block);
                                            });
                                            chatMessages.scrollTop = chatMessages.scrollHeight;
                                        }
                                    } catch (e) {
                                        console.error('Failed to parse JSON:', e);
                                    }
                                }
                            }
                        }
                    }

                    function pump() {
                        return reader.read().then(({done, value}) => {
                            if (done) {
                                if (buffer) {
                                    processText(buffer);
                                }
                                messageInput.disabled = false;
                                messageInput.focus();
                                return;
                            }

                            buffer += decoder.decode(value, {stream: true});
                            const lines = buffer.split('\n\n');
                            buffer = lines.pop();

                            for (const line of lines) {
                                processText(line);
                            }

                            return pump();
                        });
                    }

                    return pump();
                }).catch(error => {
                    console.error('Streaming error:', error);
                    responseBubble.innerHTML = formatMarkdown('An error occurred while streaming the response.');
                    messageInput.disabled = false;
                    messageInput.focus();
                });
            } else {
                // Non-streaming mode
                fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        api: apiSelect.value
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        appendMessage(`Error: ${data.error}`);
                    } else {
                        appendMessage(data.response);
                    }
                    messageInput.disabled = false;
                    messageInput.focus();
                })
                .catch(error => {
                    appendMessage('An error occurred. Please try again.');
                    messageInput.disabled = false;
                    messageInput.focus();
                });
            }
        }

        function clearChat() {
            if (!confirm('Are you sure you want to clear the chat and remove the uploaded document?')) return;

            fetch('/clear-chat', {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = '/';
                }
            })
            .catch(error => {
                alert('Failed to clear chat. Please try again.');
            });
        }
    </script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with Document</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg">
            <!-- Header -->
            <div class="border-b p-4 flex justify-between items-center">
                <h1 class="text-xl font-semibold">Document Chat</h1>
                <div class="flex space-x-4 items-center">
                    <select id="api-select" class="border rounded px-3 py-1">
                        {% for api in apis %}
                        <option value="{{ api }}">{{ api|title }}</option>
                        {% endfor %}
                    </select>
                    <label class="flex items-center">
                        <input type="checkbox" id="stream-toggle" class="mr-2" checked>
                        Stream
                    </label>
                    <button onclick="clearChat()" class="text-red-600 hover:text-red-800">
                        Clear Chat
                    </button>
                </div>
            </div>

            <!-- Chat Messages -->
            <div id="chat-messages" class="h-[500px] overflow-y-auto p-4 space-y-4">
                <!-- Messages will be inserted here -->
            </div>

            <!-- Input Area -->
            <div class="border-t p-4">
                <div class="flex space-x-4">
                    <input type="text" id="message-input"
                           class="flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Type your message...">
                    <button onclick="sendMessage()"
                            class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const messageInput = document.getElementById('message-input');
        const chatMessages = document.getElementById('chat-messages');
        const apiSelect = document.getElementById('api-select');

        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        function appendMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;

            const messageBubble = document.createElement('div');
            messageBubble.className = `max-w-[70%] rounded-lg p-3 ${
                isUser ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-800'
            }`;

            if (isUser) {
                messageBubble.textContent = content;
            } else {
                messageBubble.id = 'current-response';
                const streamContent = document.createElement('span');
                streamContent.textContent = content;
                messageBubble.appendChild(streamContent);
            }

            messageDiv.appendChild(messageBubble);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageBubble;
        }

        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            const streamMode = document.getElementById('stream-toggle').checked;
            appendMessage(message, true);
            messageInput.value = '';
            messageInput.disabled = true;

            if (streamMode) {
                // Streaming mode
                const responseBubble = appendMessage('', false);

                fetch('/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        api: apiSelect.value
                    })
                }).then(response => {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    function processText(text) {
                        const lines = text.split('\n');
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                if (data !== '[DONE]') {
                                    try {
                                        const parsed = JSON.parse(data);
                                        if (parsed.content) {
                                            responseBubble.textContent += parsed.content;
                                            chatMessages.scrollTop = chatMessages.scrollHeight;
                                        }
                                    } catch (e) {
                                        console.error('Failed to parse JSON:', e);
                                    }
                                }
                            }
                        }
                    }

                    function pump() {
                        return reader.read().then(({done, value}) => {
                            if (done) {
                                if (buffer) {
                                    processText(buffer);
                                }
                                messageInput.disabled = false;
                                messageInput.focus();
                                return;
                            }

                            buffer += decoder.decode(value, {stream: true});
                            const lines = buffer.split('\n\n');
                            buffer = lines.pop();

                            for (const line of lines) {
                                processText(line);
                            }

                            return pump();
                        });
                    }

                    return pump();
                }).catch(error => {
                    console.error('Streaming error:', error);
                    responseBubble.textContent = 'An error occurred while streaming the response.';
                    messageInput.disabled = false;
                    messageInput.focus();
                });
            } else {
                // Non-streaming mode
                fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        api: apiSelect.value
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        appendMessage(`Error: ${data.error}`);
                    } else {
                        appendMessage(data.response);
                    }
                    messageInput.disabled = false;
                    messageInput.focus();
                })
                .catch(error => {
                    appendMessage('An error occurred. Please try again.');
                    messageInput.disabled = false;
                    messageInput.focus();
                });
            }
        }

        function clearChat() {
            if (!confirm('Are you sure you want to clear the chat and remove the uploaded document?')) return;

            fetch('/clear-chat', {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = '/';
                }
            })
            .catch(error => {
                alert('Failed to clear chat. Please try again.');
            });
        }
    </script>
</body>
</html>